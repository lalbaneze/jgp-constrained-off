name: Update PLD + ONS

on:
  workflow_dispatch:
  schedule:
    - cron: "0 10 * * *"

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Update PLD (CCEE)
        working-directory: pld_ccee
        run: |
          mkdir -p data
          python src/update_pld_2025.py

      - name: Debug - list DB folder
        run: |
          ls -la
          ls -la pld_ccee
          ls -la pld_ccee/data || true
 
      - name: Export PLD JSON to dashboard/data
        run: |
          python export_pld_json.py

      - name: Update COFF monthly (ONS) - EOL
        working-directory: dashboard
        run: |
          python atualizar_coff_monthly.py

      - name: Debug EOL output head/tail
        run: |
          echo "---- ls dashboard/data ----"
          ls -la dashboard/data
          echo "---- head EOL CSV ----"
          head -n 5 dashboard/data/coff_eolica_monthly.csv || true
          echo "---- tail EOL CSV ----"
          tail -n 5 dashboard/data/coff_eolica_monthly.csv || true

      - name: Debug EOL counts by month
        run: |
          python - << 'PY'
          import pandas as pd
          p="dashboard/data/coff_eolica_monthly.csv"
          df=pd.read_csv(p)
          print("cols:", df.columns.tolist())
          print("rows:", len(df))
          col = "ym" if "ym" in df.columns else ("mes" if "mes" in df.columns else None)
          print("month_col:", col)
          if col:
            print(df[col].value_counts().sort_index().tail(30))
          PY



      - name: Update COFF monthly (ONS) - SOL
        working-directory: dashboard
        run: |
          python scripts/update_coff_solar_monthly_v3.py

      - name: Sanity check - prevent partial overwrite
        run: |
          python - << 'PY'
          import os

          def count_rows(p):
            if not os.path.exists(p):
              print("MISSING:", p); return -1
            with open(p, "r", encoding="utf-8") as f:
              return sum(1 for _ in f) - 1

          eol = "dashboard/data/coff_eolica_monthly.csv"
          sol = "dashboard/data/coff_solar_monthly.csv"

          eol_n = count_rows(eol)
          sol_n = count_rows(sol)

          print("Rows eol:", eol_n)
          print("Rows sol:", sol_n)

          # Ajuste para o seu histÃ³rico real:
          if eol_n != -1 and eol_n < 1000:
            raise SystemExit("EOL too small -> aborting")
          if sol_n != -1 and sol_n < 500:
            raise SystemExit("SOL too small -> aborting")

          print("Sanity OK")
          PY


      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add dashboard/data/pld_monthly_avg.json dashboard/data/pld_meta.json \
          dashboard/data/coff_eolica_monthly.csv dashboard/data/coff_solar_monthly.csv \
          dashboard/data/mapping_citi.json
          git commit -m "Auto update data" || echo "No changes"
          git push
