name: COFF eólica — gerar TESTE e avisar se mudou

on:
  schedule:
    - cron: "0 10 * * *"   # ~07:00 Brasil (UTC-3)
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas requests

      - name: Build TEST (does not touch official)
        run: |
          python dashboard/scripts/update_coff_eolica_monthly_test.py

      - name: Check diff TEST vs OFFICIAL
        id: diffcheck
        run: |
          python - <<'PY'
          import os, hashlib, sys

          off = "dashboard/data/coff_eolica_monthly.csv"
          tst = "dashboard/data/coff_eolica_monthly_test.csv"

          def sha256(path):
            h = hashlib.sha256()
            with open(path, "rb") as f:
              for chunk in iter(lambda: f.read(1024*1024), b""):
                h.update(chunk)
            return h.hexdigest()

          if not os.path.exists(tst):
            print("TEST file not found:", tst)
            sys.exit(1)

          if not os.path.exists(off):
            # se não existe oficial por algum motivo, considera "mudou" pra você ver
            print("OFFICIAL file not found; treating as changed.")
            print("changed=true")
            sys.exit(0)

          changed = (sha256(off) != sha256(tst))
          print("changed=" + ("true" if changed else "false"))
          PY

          # exporta para o GitHub Actions env
          CHANGED=$(python - <<'PY'
          import os, hashlib
          off = "dashboard/data/coff_eolica_monthly.csv"
          tst = "dashboard/data/coff_eolica_monthly_test.csv"
          def sha256(path):
            h = hashlib.sha256()
            with open(path, "rb") as f:
              for chunk in iter(lambda: f.read(1024*1024), b""):
                h.update(chunk)
            return h.hexdigest()
          if not os.path.exists(off):
            print("true")
          else:
            print("true" if sha256(off)!=sha256(tst) else "false")
          PY)
          echo "changed=$CHANGED" >> $GITHUB_OUTPUT

      - name: Create/Update PR with TEST file only (if changed)
        if: steps.diffcheck.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          branch: bot/coff-eolica-test
          title: "COFF eólica: TESTE mudou (revisar antes de publicar)"
          commit-message: "Update COFF eólica TESTE (ONS)"
          body: |
            Atualização diária gerou diferença entre:
            - oficial: dashboard/data/coff_eolica_monthly.csv
            - teste:   dashboard/data/coff_eolica_monthly_test.csv

            ✅ O site NÃO foi atualizado automaticamente.
            Revise o diff do TESTE. Se estiver ok, promova manualmente copiando:
            dashboard/data/coff_eolica_monthly_test.csv -> dashboard/data/coff_eolica_monthly.csv
          add-paths: |
            dashboard/data/coff_eolica_monthly_test.csv
